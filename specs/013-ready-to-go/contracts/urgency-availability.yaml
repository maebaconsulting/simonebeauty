openapi: 3.0.3
info:
  title: Ready to Go - Urgency Availability API
  version: 1.0.0
  description: |
    API pour vérifier la disponibilité des prestataires Ready to Go
    pour les réservations urgentes selon les 3 paliers (Express, Rapide, Aujourd'hui)

servers:
  - url: https://{project-ref}.supabase.co/functions/v1
    description: Supabase Edge Functions
    variables:
      project-ref:
        default: your-project-ref

paths:
  /urgency/check-availability:
    post:
      summary: Vérifier la disponibilité pour une réservation urgente
      description: |
        Retourne la liste des prestataires disponibles pour chaque palier d'urgence
        avec les créneaux horaires disponibles, le temps de trajet et le bonus.
      operationId: checkUrgencyAvailability
      tags:
        - Availability
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - serviceId
                - clientAddress
              properties:
                serviceId:
                  type: integer
                  format: int64
                  description: ID du service à réserver
                  example: 42
                clientAddress:
                  type: object
                  required:
                    - latitude
                    - longitude
                    - postalCode
                  properties:
                    latitude:
                      type: number
                      format: double
                      example: 48.8566
                    longitude:
                      type: number
                      format: double
                      example: 2.3522
                    postalCode:
                      type: string
                      example: "75001"
                    city:
                      type: string
                      example: "Paris"
                    fullAddress:
                      type: string
                      example: "123 Rue de Rivoli, 75001 Paris"
                urgencyLevels:
                  type: array
                  description: Paliers à vérifier (par défaut tous)
                  items:
                    type: string
                    enum: [express, fast, today]
                  example: ["express", "fast", "today"]
      responses:
        '200':
          description: Disponibilités par palier
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      express:
                        $ref: '#/components/schemas/TierAvailability'
                      fast:
                        $ref: '#/components/schemas/TierAvailability'
                      today:
                        $ref: '#/components/schemas/TierAvailability'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /urgency/contractor-slots:
    post:
      summary: Obtenir les créneaux disponibles d'un prestataire spécifique
      description: |
        Retourne les créneaux disponibles d'un prestataire pour un palier d'urgence donné
      operationId: getContractorUrgencySlots
      tags:
        - Availability
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - contractorId
                - urgencyLevel
                - serviceId
                - clientAddress
              properties:
                contractorId:
                  type: integer
                  format: int64
                  example: 123
                urgencyLevel:
                  type: string
                  enum: [express, fast, today]
                  example: "fast"
                serviceId:
                  type: integer
                  format: int64
                  example: 42
                clientAddress:
                  $ref: '#/components/schemas/ClientAddress'
      responses:
        '200':
          description: Créneaux disponibles pour ce prestataire
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      contractor:
                        $ref: '#/components/schemas/ContractorInfo'
                      availableSlots:
                        type: array
                        items:
                          $ref: '#/components/schemas/TimeSlot'
                      travelTimeMinutes:
                        type: integer
                        example: 15
                      bonusAmount:
                        type: number
                        format: decimal
                        example: 12.00
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: Prestataire non trouvé ou pas disponible en Ready to Go
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  schemas:
    TierAvailability:
      type: object
      properties:
        urgencyLevel:
          type: string
          enum: [express, fast, today]
          example: "fast"
        label:
          type: string
          example: "Rapide (1h-2h)"
        timeWindow:
          type: object
          properties:
            minMinutes:
              type: integer
              example: 60
            maxMinutes:
              type: integer
              example: 120
            startTime:
              type: string
              format: date-time
              example: "2025-11-07T15:00:00Z"
            endTime:
              type: string
              format: date-time
              example: "2025-11-07T16:00:00Z"
        pricing:
          $ref: '#/components/schemas/UrgencyPricing'
        contractorsAvailable:
          type: integer
          description: Nombre de prestataires disponibles
          example: 5
        contractors:
          type: array
          items:
            $ref: '#/components/schemas/ContractorAvailability'
        isAvailable:
          type: boolean
          description: Au moins un prestataire disponible
          example: true
        message:
          type: string
          description: Message si aucun prestataire disponible
          example: "Aucun prestataire disponible. Essayez 'Aujourd'hui' (8 prestataires)"

    ContractorAvailability:
      type: object
      properties:
        contractorId:
          type: integer
          format: int64
          example: 123
        contractorInfo:
          $ref: '#/components/schemas/ContractorInfo'
        availableSlots:
          type: array
          items:
            $ref: '#/components/schemas/TimeSlot'
        travelTimeMinutes:
          type: integer
          example: 15
        bonusAmount:
          type: number
          format: decimal
          description: Bonus que le prestataire recevra
          example: 12.00
        rating:
          type: number
          format: float
          example: 4.8
        completedBookings:
          type: integer
          example: 127

    ContractorInfo:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 123
        firstName:
          type: string
          example: "Marie"
        lastName:
          type: string
          example: "Dupont"
        profilePhotoUrl:
          type: string
          format: uri
          example: "https://storage.supabase.co/contractors/123/profile.jpg"
        professionalTitle:
          type: string
          example: "Masseuse professionnelle certifiée"
        rating:
          type: number
          format: float
          example: 4.8
        reviewCount:
          type: integer
          example: 45

    TimeSlot:
      type: object
      properties:
        startTime:
          type: string
          format: date-time
          example: "2025-11-07T15:30:00Z"
        endTime:
          type: string
          format: date-time
          example: "2025-11-07T16:30:00Z"
        departureTime:
          type: string
          format: date-time
          description: Heure à laquelle le prestataire doit partir
          example: "2025-11-07T15:15:00Z"
        arrivalTime:
          type: string
          format: date-time
          description: Heure d'arrivée estimée chez le client
          example: "2025-11-07T15:30:00Z"

    UrgencyPricing:
      type: object
      properties:
        surchargePercent:
          type: number
          format: decimal
          example: 30.00
        surchargeAmount:
          type: number
          format: decimal
          example: 24.00
        contractorBonus:
          type: number
          format: decimal
          example: 12.00
        platformRevenue:
          type: number
          format: decimal
          example: 12.00
        totalPrice:
          type: number
          format: decimal
          example: 104.00
        basePrice:
          type: number
          format: decimal
          example: 80.00

    ClientAddress:
      type: object
      required:
        - latitude
        - longitude
        - postalCode
      properties:
        latitude:
          type: number
          format: double
          example: 48.8566
        longitude:
          type: number
          format: double
          example: 2.3522
        postalCode:
          type: string
          example: "75001"
        city:
          type: string
          example: "Paris"
        fullAddress:
          type: string
          example: "123 Rue de Rivoli, 75001 Paris"

    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              example: "CONTRACTOR_NOT_FOUND"
            message:
              type: string
              example: "Prestataire non trouvé"

  responses:
    BadRequest:
      description: Requête invalide
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              code: "INVALID_REQUEST"
              message: "serviceId est requis"

    Unauthorized:
      description: Non authentifié
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              code: "UNAUTHORIZED"
              message: "Token d'authentification manquant ou invalide"

    InternalError:
      description: Erreur serveur
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              code: "INTERNAL_ERROR"
              message: "Une erreur est survenue lors de la vérification de disponibilité"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - BearerAuth: []
